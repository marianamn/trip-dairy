"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.diariesController=void 0;var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),_jquery=require("jquery"),_jquery2=_interopRequireDefault(_jquery),_handlebars=require("handlebars"),_handlebars2=_interopRequireDefault(_handlebars),_utils=require("utils"),_templates=require("templates"),_tinymce=require("tinymce"),_tinymce2=_interopRequireDefault(_tinymce),_toastr=require("toastr"),_toastr2=_interopRequireDefault(_toastr),_diariesData=require("diariesData"),_usersData=require("usersData"),diariesController=function(){var t=function(){function t(e,a){_classCallCheck(this,t),this.data=e,this.templates=a}return _createClass(t,[{key:"diaryById",value:function(t){var e=this,a=void 0,r=void 0,n=t.id;this.data.getTripDiaryById(n).then(function(t){a=t.data;var r=_utils.UTILS.HELPER_FUNCTIONS.getDate(new Date(a.postDate)),n=_utils.UTILS.HELPER_FUNCTIONS.getMonth(new Date(a.postDate));return a.date={date:r,month:n},a.comments.forEach(function(t){var e=_utils.UTILS.HELPER_FUNCTIONS.transformDate(new Date(t.postDate));t.date={date:e}}),e.data.getAllTripsDiaries()}).then(function(t){r=t.data;var n=_utils.UTILS.HELPER_FUNCTIONS.getNextAndPreviousDiary(r,a._id);return a.previous={_id:n.prev._id,title:n.prev.title,mainImage:n.prev.mainImage,author:n.prev.author},a.next={_id:n.next._id,title:n.next.title,mainImage:n.next.mainImage,author:n.next.author},e.templates.get("diary-details")}).then(function(t){var r=_handlebars2.default.compile(t);(0,_jquery2.default)("#content").html(r(a)),null!==localStorage.getItem("auth_email")&&((0,_jquery2.default)(".post-comment").removeClass("hidden"),(0,_jquery2.default)(".btn-replay").removeClass("hidden")),(0,_jquery2.default)(".horizontal-separator").last().addClass("hidden"),(0,_jquery2.default)(".btn-post-comment").on("click",function(t){t.preventDefault();var r={diaryId:a._id,author:localStorage.getItem("fullName"),profileImgURL:localStorage.getItem("profileImg"),body:(0,_jquery2.default)("#replay-area").val(),postDate:new Date};return e.data.addComment(r).then(function(t){_toastr2.default.success("Comment was added!")}).catch(function(t){_toastr2.default.error("Comment adding failed!")}),!1})})}},{key:"diariesByCategory",value:function(t){var e=this,a=void 0,r=t.category;this.data.getAllTripsDiaries().then(function(t){return a=_utils.UTILS.HELPER_FUNCTIONS.tripDiariesByCategory(t,r),a.category=r,e.templates.get("trips-by-category")}).then(function(t){var e=_handlebars2.default.compile(t);(0,_jquery2.default)("#content").html(e(a))})}},{key:"diariesByUser",value:function(){var t=this,e=void 0,a=void 0,r=void 0;this.data.getAllTripsDiaries().then(function(n){return e=_utils.UTILS.HELPER_FUNCTIONS.getTripsByAuthor(n),_usersData.usersData.getAllUsers().then(function(t){a=t.data,e.forEach(function(t){r=_utils.UTILS.HELPER_FUNCTIONS.getUserInfo(a,t.author),t.userInfo={_id:r._id,fullName:r.firstName+" "+r.lastName,profileImage:r.profileImgURL,userInfo:r.userInfo,facebookContact:r.facebookContact,youTubeContact:r.youTubeContact,twitterContact:r.twitterContact,googlePlusContact:r.googlePlusContact,instagramContact:r.instagramContact,rssContact:r.rssContact}})}),t.templates.get("diaries-by-author")}).then(function(t){var a=_handlebars2.default.compile(t);(0,_jquery2.default)("#content").html(a(e)),(0,_jquery2.default)(".author-container:odd").addClass("flex-last")})}},{key:"addNewDiary",value:function(){var t=this,e=void 0;this.templates.get("add-diary").then(function(a){var r=_handlebars2.default.compile(a);(0,_jquery2.default)("#content").html(r()),_utils.UTILS.HELPER_FUNCTIONS.tinyMceInit(),(0,_jquery2.default)("#btn-add-diary").on("click",function(){return _usersData.usersData.getAllUsers().then(function(t){e=t.data;for(var a=_utils.UTILS.HELPER_FUNCTIONS.getUserFullName(e,localStorage.getItem("auth_email")),r=[],n=(0,_jquery2.default)("#tb-images").val().split(","),i=0;i<n.length;i++)r.push(n[i].trim());return{title:(0,_jquery2.default)("#tb-title").val(),author:a,place:(0,_jquery2.default)("#tb-place").val(),category:(0,_jquery2.default)("#tb-category :selected").val(),content:_tinymce2.default.get("tb-content").getContent({format:"html"}),postDate:Date.now(),mainImage:(0,_jquery2.default)("#tb-mainImage").val(),images:r}}).then(function(e){t.data.addDiary(e).then(function(t){console.log(t),_toastr2.default.success("Diary successfully added!"),window.location="/"}).catch(function(t){return console.log(t),_toastr2.default.error(t.statusText,"Error")})}),!1})})}}]),t}(),e=new t(_diariesData.tripsDiariesData,_templates.templatesLoader);return{diaryById:function(t){return e.diaryById(t)},diariesByCategory:function(t){return e.diariesByCategory(t)},diariesByUser:function(){return e.diariesByUser()},addNewDiary:function(){return e.addNewDiary()}}}();exports.diariesController=diariesController;